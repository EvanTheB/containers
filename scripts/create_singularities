#!/bin/bash
#emacs: -*- mode: shell-script; c-basic-offset: 4; tab-width: 4; indent-tabs-mode: t -*- 
#ex: set sts=4 ts=4 sw=4 noet:
#
#
# COPYRIGHT: Yaroslav Halchenko 2018
#
# LICENSE: MIT
#
#  Permission is hereby granted, free of charge, to any person obtaining a copy
#  of this software and associated documentation files (the "Software"), to deal
#  in the Software without restriction, including without limitation the rights
#  to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
#  copies of the Software, and to permit persons to whom the Software is
#  furnished to do so, subject to the following conditions:
#
#  The above copyright notice and this permission notice shall be included in
#  all copies or substantial portions of the Software.
#
#  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
#  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
#  FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
#  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
#  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
#  OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
#  THE SOFTWARE.
#

set -eu

function info() {
	echo "I: $@"
}

function create_singularity_file() {
	dh="$1"
	name=${dh//\//-}
	version_tag="$2"
	mkdir -p sing
	info "$dh $name $version_tag"
}

curl -s -k https://raw.githubusercontent.com/BIDS-Apps/bids-apps.github.io/master/_config.yml \
	| awk '/^ *dh:/{print $2}' \
	| sed -e "s,',,g" \
	| while read dh; do
	j=$(curl -s -k https://registry.hub.docker.com/v1/repositories/$dh/tags)
	versions=$(echo "$j" | jq -c '.[]["name"]' | sed -e 's,",,g' -ne '/^v*[0-9][-0-9.]*/p')
	last_version=$(echo -e "$versions" |sort -nr |head -n 1)
	if [ ! -z "$last_version" ]; then
		pure_last_version=$(echo $last_version | sed -e 's,^v,,g')
		# echo $dh $last_version
		create_singularity_file "$dh" "$last_version"
	else
		info $dh no version. Tags: $versions
	fi
done
